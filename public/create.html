<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Enigma Bridge file sharing demo</title>
    <link rel="shortcut icon" type="image/png" href="favicon.png" />
    <style>
        body,p,td,input {font-family: Arial, Helvetica, sans-serif; font-size: 10pt;}
        h1 {font-size: 14pt; }
        h2 {font-size: 12pt; }
        .qr {
            padding-top: 10px;
            display: block;
            margin-left: auto;
            margin-right: auto;
            text-align: center;
        }
        .qrWrap {
            /*overflow: auto;*/
        }

        body
        {
            font-family: Roboto, sans-serif;
            color: #0f3c4b;
        }

        .box
        {
            font-size: 1.25rem; /* 20 */
            background-color: #c8dadf;
            position: relative;
            padding: 100px 20px;
            text-align: center;
        }
        .box.has-advanced-upload
        {
            outline: 2px dashed #92b0b3;
            outline-offset: -10px;

            -webkit-transition: outline-offset .15s ease-in-out, background-color .15s linear;
            transition: outline-offset .15s ease-in-out, background-color .15s linear;
        }
        .box.is-dragover
        {
            outline-offset: -20px;
            outline-color: #c8dadf;
            background-color: #fff;
        }
        .box__dragndrop,
        .box__icon
        {
            display: none;
        }
        .box.has-advanced-upload .box__dragndrop
        {
            display: inline;
            font-size: inherit;
        }
        .box.has-advanced-upload .box__icon
        {
            width: 100%;
            height: 80px;
            fill: #92b0b3;
            display: block;
            margin-bottom: 40px;
        }

        .box.is-uploading .box__input,
        .box.is-success .box__input,
        .box.is-error .box__input
        {
            visibility: hidden;
        }

        .box__uploading,
        .box__success,
        .box__error
        {
            display: none;
        }
        .box.is-uploading .box__uploading,
        .box.is-success .box__success,
        .box.is-error .box__error
        {
            display: block;
            position: absolute;
            margin: 0 15px 0 15px;
            top: 50%;
            right: 0;
            left: 0;

            -webkit-transform: translateY( -50% );
            transform: translateY( -50% );
        }
        .box__uploading
        {
            font-style: italic;
        }
        .box__success
        {
            -webkit-animation: appear-from-inside .25s ease-in-out;
            animation: appear-from-inside .25s ease-in-out;
        }
        @-webkit-keyframes appear-from-inside
        {
            from	{ -webkit-transform: translateY( -50% ) scale( 0 ); }
            75%		{ -webkit-transform: translateY( -50% ) scale( 1.1 ); }
            to		{ -webkit-transform: translateY( -50% ) scale( 1 ); }
        }
        @keyframes appear-from-inside
        {
            from	{ transform: translateY( -50% ) scale( 0 ); }
            75%		{ transform: translateY( -50% ) scale( 1.1 ); }
            to		{ transform: translateY( -50% ) scale( 1 ); }
        }

        .box__restart
        {
            font-weight: 700;
        }
        .box__restart:focus,
        .box__restart:hover
        {
            color: #39bfd3;
        }

        .js .box__file
        {
            width: 0.1px;
            height: 0.1px;
            opacity: 0;
            overflow: hidden;
            position: absolute;
            z-index: -1;
        }
        .js .box__file + label
        {
            max-width: 80%;
            text-overflow: ellipsis;
            white-space: nowrap;
            cursor: pointer;
            display: inline-block;
            overflow: hidden;
            font-size: inherit;
        }
        .js .box__file + label:hover strong,
        .box__file:focus + label strong,
        .box__file.has-focus + label strong
        {
            color: #39bfd3;
        }
        .js .box__file:focus + label,
        .js .box__file.has-focus + label
        {
            outline: 1px dotted #000;
            outline: -webkit-focus-ring-color auto 5px;
        }
        .js .box__file + label *
        {
            /* pointer-events: none; */ /* in case of FastClick lib use */
        }

        .no-js .box__file + label
        {
            display: none;
        }

        .no-js .box__button
        {
            display: block;
        }
        .box__button
        {
            font-weight: 700;
            color: #e5edf1;
            background-color: #39bfd3;
            display: block;
            padding: 8px 16px;
            margin: 40px auto 0;
            border: 0px;
        }
        .box__button:hover,
        .box__button:focus
        {
            background-color: #0f3c4b;
        }

    </style>
    <link href='css/googleapi-FamilyBitter.css' rel='stylesheet' type='text/css'/>
    <link href="forms.css" rel="stylesheet" type="text/css"/>
    <!-- remove this if you use Modernizr -->
    <script>(function(e,t,n){var r=e.querySelectorAll("html")[0];r.className=r.className.replace(/(^|\s)no-js(\s|$)/,"$1js$2")})(document,window,0);</script>
    <script src="jquery-1.12.1.min.js"></script>
    <script src="sprintf.js"></script>
    <script src="sjcl.js"></script>
    <script src="jquery.qrcode.min.js"></script>
    <script src="he.js"></script>
    <script src="enigma.js"></script>
    <script src="demo.js"></script>
    <script>
        "use strict";
        var defaults = {
            site: 'site2.enigmabridge.com',
            site1: 'site1.enigmabridge.com',
            site2: 'site2.enigmabridge.com'
        };

        // Google Drive access token.
        var accessToken = null;

        // Upload context.
        var isAdvancedUpload = false;
        var droppedFiles = false;
        var updForm;

        // We have only one upload form.
        var $fldInput;
        var $fldLabel;
        var $fldErrorMsg;
        var $fldRestart;
    </script>
</head>
<body>

<!-- form design: http://www.sanwebe.com/2014/08/css-html-forms-designs -->
<!-- info: http://jacob.jkrall.net/totp/ -->
<!-- uploader:
    https://css-tricks.com/examples/DragAndDropFileUploading/
    https://css-tricks.com/drag-and-drop-file-uploading/
    http://www.html5rocks.com/en/tutorials/file/dndfiles/
-->
<div class="form-style-10">
    <h1>Secure file sharing<span>EnigmaBridge demo</span></h1>
    <div>
        <div class="section"><span>1</span>Input</div>
        <div class="inner-wrap">
            <label>Message
                <input type="text" name="message" id="message" value="" placeholder="Message to encrypt & share"/>
                <span>Message to be encrypted and shared in a secure way, using simple unsecure storage, such as Google Drive.</span>
            </label>

            <div class="js box">
                <div class="box__input">
                    <svg class="box__icon" xmlns="http://www.w3.org/2000/svg" width="50" height="43" viewBox="0 0 50 43">
                        <path d="M48.4 26.5c-.9 0-1.7.7-1.7 1.7v11.6h-43.3v-11.6c0-.9-.7-1.7-1.7-1.7s-1.7.7-1.7 1.7v13.2c0 .9.7 1.7 1.7 1.7h46.7c.9 0 1.7-.7 1.7-1.7v-13.2c0-1-.7-1.7-1.7-1.7zm-24.5 6.1c.3.3.8.5 1.2.5.4 0 .9-.2 1.2-.5l10-11.6c.7-.7.7-1.7 0-2.4s-1.7-.7-2.4 0l-7.1 8.3v-25.3c0-.9-.7-1.7-1.7-1.7s-1.7.7-1.7 1.7v25.3l-7.1-8.3c-.7-.7-1.7-.7-2.4 0s-.7 1.7 0 2.4l10 11.6z"/>
                    </svg>
                    <input type="file" name="files[]" id="file" class="box__file" />
                    <label for="file"><strong>Choose a file</strong><span class="box__dragndrop"> or drag it here</span>.</label>
                    <!--<button type="button" class="box__button">Upload</button>-->
                </div>

                <div class="box__uploading">Uploading&hellip;</div>
                <div class="box__success">Done! <a href="https://css-tricks.com/examples/DragAndDropFileUploading//?submit-on-demand" class="box__restart" role="button">Upload more?</a></div>
                <div class="box__error">Error! <span></span>. <a href="https://css-tricks.com/examples/DragAndDropFileUploading//?submit-on-demand" class="box__restart" role="button">Try again!</a></div>
            </div>

        </div>

        <div class="section" id="gDriveConfigHead">
            <span>2</span>
            GoogleDrive
            <div class="collapser">[-]</div>
        </div>
        <div class="inner-wrap" id="gDriveConfig">
            <!--
            https://developers.google.com/drive/v3/web/quickstart/js#prerequisites
            https://github.com/googledrive/cors-upload-sample/blob/master/index.html
            -->
            <span id="signin">
                <span
                        class="g-signin"
                        data-callback="signinCallback"
                        data-clientid="1044449456843-q4lt3nk61gulb67irbr45jvcr2siqfks.apps.googleusercontent.com"
                        data-cookiepolicy="single_host_origin"
                        data-scope="https://www.googleapis.com/auth/drive.file">
                </span>
            </span>
            <span id="signedin" style="display: none;">
                Already signed in
            </span>
        </div>

        <div class="section" id="divConfigHead">
            <span>3</span>
            Configuration
            <div class="collapser">[-]</div>
        </div>
        <div class="inner-wrap" id="divConfig">
            <label>API Key
                <input type="text" name="apiKey" id="apiKey" value="TEST_API"/>
                <span>Your EB API key</span>
            </label>

            <label>User object ID
                <input type="text" name="userObjectID" id="userObjectID" value="8855"/>
                <span>User object used for HOTP context generation</span>
            </label>

            <label>ProcessData method
                <input type="text" name="processDataMethod" id="processDataMethod" value="AUTH_NEWUSERCTX"/>
                <span></span>
            </label>

            <label>Endpoint
                <input type="text" name="endpoint" id="endpoint" placeholder="endpoint.address.com"/>
                <span>Hostname of the EB API
                    <a onclick="$('#endpoint').val(defaults.site1);">site1</a>,
                    <a onclick="$('#endpoint').val(defaults.site2);">site2</a></span>
            </label>

            <label>Method
                <select id="requestMethod" name="requestMethod">
                    <option value="POST">POST</option>
                    <option value="GET">GET</option>
                </select>
            </label>

            <label>Scheme
                <select id="requestScheme" name="requestScheme">
                    <option value="https">https</option>
                    <option value="http">http</option>
                </select>
            </label>

            <label>AES encryption key
                <input type="text" name="aesKey" id="aesKey" value="1234567890123456789012345678901234567890123456789012345678901234"/>
                <span>Hexcoded encryption API key
                </span>
            </label>

            <label>MAC key
                <input type="text" name="macKey" id="macKey" value="2224262820223456789012345678901234567890123456789012345678901234"/>
                <span>Hexcoded hmac API key
                </span>
            </label>
        </div>

        <div class="section"><span>4</span>Response</div>
        <div class="inner-wrap">
            <label>Status code
                <input type="text" name="hotpStatus" id="hotpStatus" placeholder="HOTP status code" readonly="readonly"/>
                <span>9000 means success</span>
            </label>

            <label style="display: none">Generated user ID
                <input type="text" name="userId" id="userId" placeholder="hex-coded user ID" readonly="readonly"/>
                <span>User ID generated by the service</span>
            </label>

            <label style="display: none">HOTP secret
                <input type="text" name="hotpSecret" id="hotpSecret" placeholder="HOTP secret key" readonly="readonly" class="crc-src"/>
                <input type="text" name="hotpSecretCrc" id="hotpSecretCrc" placeholder="CRC" readonly="readonly" class="crc-dst"/>
                <span>HOTP secret key for the user, used for HOTP token initialization</span>
            </label>

            <label style="display: none">User context
                <input type="text" name="userCtx" id="userCtx" placeholder="binary blob" readonly="readonly" class="crc-src"/>
                <input type="text" name="userCtxCrc" id="userCtxCrc" placeholder="CRC" readonly="readonly" class="crc-dst"/>
                <span>User context generated by the service, used for further authentication requests</span>
            </label>

            <label style="display: none">First 5 codes
                <input type="text" name="htops" id="htops" placeholder="000000 111111 222222 333333 444444" readonly="readonly"/>
                <span>First HOTP codes generated, should match HOTP authenticator output.</span>
            </label>

            <label style="display: none">QR link
                <input type="text" name="qrLink" id="qrLink" placeholder="QR code content" readonly="readonly"/>
                <span>QR code content used to initialize authenticator</span>
            </label>

            <div id="redirBlock">
                <a href="#" id="redirHref" target="_blank">Try authentication here</a>
            </div>

            <div class="qrWrap">
                <div id="qrcode" class="qr"></div>
            </div>
        </div>
        <div class="button-section">
            <input type="button" id="btnShare" value="Share"/>
        </div>
    </form>
</div>

<label for="reqRest">Request: </label>
<div id="reqRest" class="logbox"></div>
<br/>

<label for="status">Log: </label>
<div id="status" class="logbox"></div>

<script>
    "use strict";
    $('#endpoint').val(defaults.site);
    $('#divConfigHead').click(toggleCategory);
    $('#gDriveConfigHead').click(toggleCategory);
    $('#divConfigHead').click();

    /**
     * Helper for implementing retries with backoff. Initial retry
     * delay is 1 second, increasing by 2x (+jitter) for subsequent retries
     *
     * @constructor
     */
    var RetryHandler = function() {
        this.interval = 1000; // Start at one second
        this.maxInterval = 60 * 1000; // Don't wait longer than a minute
    };

    /**
     * Invoke the function after waiting
     *
     * @param {function} fn Function to invoke
     */
    RetryHandler.prototype.retry = function(fn) {
        setTimeout(fn, this.interval);
        this.interval = this.nextInterval_();
    };

    /**
     * Reset the counter (e.g. after successful request.)
     */
    RetryHandler.prototype.reset = function() {
        this.interval = 1000;
    };

    /**
     * Calculate the next wait time.
     * @return {number} Next wait interval, in milliseconds
     *
     * @private
     */
    RetryHandler.prototype.nextInterval_ = function() {
        var interval = this.interval * 2 + this.getRandomInt_(0, 1000);
        return Math.min(interval, this.maxInterval);
    };

    /**
     * Get a random int in the range of min to max. Used to add jitter to wait times.
     *
     * @param {number} min Lower bounds
     * @param {number} max Upper bounds
     * @private
     */
    RetryHandler.prototype.getRandomInt_ = function(min, max) {
        return Math.floor(Math.random() * (max - min + 1) + min);
    };

    /**
     * Helper class for resumable uploads using XHR/CORS. Can upload any Blob-like item, whether
     * files or in-memory constructs.
     *
     * @example
     * var content = new Blob(["Hello world"], {"type": "text/plain"});
     * var uploader = new MediaUploader({
     *   file: content,
     *   token: accessToken,
     *   onComplete: function(data) { ... }
     *   onError: function(data) { ... }
     * });
     * uploader.upload();
     *
     * @constructor
     * @param {object} options Hash of options
     * @param {string} options.token Access token
     * @param {blob} options.file Blob-like item to upload
     * @param {string} [options.fileId] ID of file if replacing
     * @param {object} [options.params] Additional query parameters
     * @param {string} [options.contentType] Content-type, if overriding the type of the blob.
     * @param {object} [options.metadata] File metadata
     * @param {function} [options.onComplete] Callback for when upload is complete
     * @param {function} [options.onProgress] Callback for status for the in-progress upload
     * @param {function} [options.onError] Callback if upload fails
     */
    var MediaUploader = function(options) {
        var noop = function() {};
        this.file = options.file;
        this.contentType = options.contentType || this.file.type || 'application/octet-stream';
        this.metadata = options.metadata || {
                    'title': this.file.name,
                    'mimeType': this.contentType
                };
        this.token = options.token;
        this.onComplete = options.onComplete || noop;
        this.onProgress = options.onProgress || noop;
        this.onError = options.onError || noop;
        this.offset = options.offset || 0;
        this.chunkSize = options.chunkSize || 262144; // requirement by Google, minimal size of a chunk.
        this.retryHandler = new RetryHandler();
        this.encKey = options.encKey;
        this.textMsg = options.textMsg || undefined;

        this.url = options.url;
        this.aes = new sjcl.cipher.aes(this.encKey);
        this.reader = new FileReader();
        this.iv = sjcl.random.randomWords(4); // initialization vector for GCM, 1 block, 16B.
        if (!this.url) {
            var params = options.params || {};
            params.uploadType = 'resumable';
            this.url = this.buildUrl_(options.fileId, params, options.baseUrl);
        }
        this.httpMethod = options.fileId ? 'PUT' : 'POST';
        this.totalSize = this.totalSize_();
    };

    /**
     * Initiate the upload.
     * Store file metadata, start resumable upload to obtain upload ID.
     */
    MediaUploader.prototype.upload = function() {
        var self = this;
        var xhr = new XMLHttpRequest();

        xhr.open(this.httpMethod, this.url, true);
        xhr.setRequestHeader('Authorization', 'Bearer ' + this.token);
        xhr.setRequestHeader('Content-Type', 'application/json');
        xhr.setRequestHeader('X-Upload-Content-Length', this.totalSize);
        xhr.setRequestHeader('X-Upload-Content-Type', this.contentType);

        xhr.onload = function(e) {
            if (e.target.status < 400) {
                var location = e.target.getResponseHeader('Location');
                this.url = location;
                log("Upload session started. Url: " + this.url);

                this.sendFile_();
            } else {
                this.onUploadError_(e);
            }
        }.bind(this);
        xhr.onerror = this.onUploadError_.bind(this);
        xhr.send(JSON.stringify(this.metadata));
    };

    /**
     * Send the actual file content.
     * Subsequently called after previous chunk was uploaded successfully or to
     * re-upload the same chunk in case of an error.
     *
     * @private
     */
    MediaUploader.prototype.sendFile_ = function() {
        var content = this.file;
        var end = this.file.size;
        var lstBlock = false;

        if (this.offset || this.chunkSize) {
            // Only bother to slice the file if we're either resuming or uploading in chunks
            if (this.chunkSize) {
                // TODO: the beginning has special format - take IV, plaintext data, then file, still
                // has to fit in 256k chunk.
                //var curChunk = this.offset == 0 ? this.totalSize-this.file.size : this.chunkSize;
                end = Math.min(this.offset + this.chunkSize, this.file.size);
                lstBlock = end >= this.file.size
            }
            content = content.slice(this.offset, end);
        }

        // If we use onloadend, we need to check the readyState.
        var onLoadFnc = function(evt) {
            log("onLoaded: " + evt.target.readyState);
            if (evt.target.readyState == FileReader.DONE) { // DONE == 2
                var data = evt.target.result;
                console.log(data);

                log(sprintf("Read bytes: %s - %s of %s B file. TotalSize: %s B, ArrayBuffer: %s B",
                        this.offset, end, this.file.size, this.totalSize, data.byteLength));

                // Convert to SJCL bitArray
                var w = sjcl.bitArray;
                var ba = sjcl.codec.arrayBuffer.toBits(data);

                // TODO: prepend file with text message
                // TODO: prepend file with IV
                // TODO: prepend file with encrypted file encryption key
                // TODO: encrypt this chunk with AES GCM.
                // ...
                if (lstBlock){
                    this.onError("Upload aborted in testing mode");
                    return;
                }

                var xhr = new XMLHttpRequest();
                xhr.open('PUT', this.url, true);
                xhr.setRequestHeader('Content-Type', this.contentType);
                xhr.setRequestHeader('Content-Range', "bytes " + this.offset + "-" + (end - 1) + "/" + this.totalSize);
                xhr.setRequestHeader('X-Upload-Content-Type', this.file.type);
                if (xhr.upload) {
                    xhr.upload.addEventListener('progress', this.onProgress);
                }
                xhr.onload = this.onContentUploadSuccess_.bind(this);
                xhr.onerror = this.onContentUploadError_.bind(this);
                xhr.send(content);
            }
        };

        log("Upload chunk, offset: " + this.offset + ", end: " + end + ", lastBlock: " + lstBlock);
        console.log(content);

        this.reader.onloadend = onLoadFnc.bind(this);
        this.reader.readAsArrayBuffer(content);
    };

    /**
     * Query for the state of the file for resumption.
     *
     * @private
     */
    MediaUploader.prototype.resume_ = function() {
        var xhr = new XMLHttpRequest();
        xhr.open('PUT', this.url, true);
        xhr.setRequestHeader('Content-Range', "bytes */" + this.totalSize);
        xhr.setRequestHeader('X-Upload-Content-Type', this.file.type);
        if (xhr.upload) {
            xhr.upload.addEventListener('progress', this.onProgress);
        }
        xhr.onload = this.onContentUploadSuccess_.bind(this);
        xhr.onerror = this.onContentUploadError_.bind(this);
        xhr.send();
    };

    /**
     * Extract the last saved range if available in the request.
     *
     * @param {XMLHttpRequest} xhr Request object
     */
    MediaUploader.prototype.extractRange_ = function(xhr) {
        var range = xhr.getResponseHeader('Range');
        if (range) {
            this.offset = parseInt(range.match(/\d+/g).pop(), 10) + 1;
        }
    };

    /**
     * Handle successful responses for uploads. Depending on the context,
     * may continue with uploading the next chunk of the file or, if complete,
     * invokes the caller's callback.
     *
     * @private
     * @param {object} e XHR event
     */
    MediaUploader.prototype.onContentUploadSuccess_ = function(e) {
        if (e.target.status == 200 || e.target.status == 201) {
            this.onComplete(e.target.response);
        } else if (e.target.status == 308) {
            this.extractRange_(e.target);
            this.retryHandler.reset();
            this.sendFile_();
        } else {
            this.onContentUploadError_(e);
        }
    };

    /**
     * Handles errors for uploads. Either retries or aborts depending
     * on the error.
     *
     * @private
     * @param {object} e XHR event
     */
    MediaUploader.prototype.onContentUploadError_ = function(e) {
        if (e.target.status && e.target.status < 500) {
            this.onError(e.target.response);
        } else {
            this.retryHandler.retry(this.resume_.bind(this));
        }
    };

    /**
     * Handles errors for the initial request.
     *
     * @private
     * @param {object} e XHR event
     */
    MediaUploader.prototype.onUploadError_ = function(e) {
        this.onError(e.target.response); // TODO - Retries for initial upload
    };

    /**
     * Construct a query string from a hash/object
     *
     * @private
     * @param {object} [params] Key/value pairs for query string
     * @return {string} query string
     */
    MediaUploader.prototype.buildQuery_ = function(params) {
        params = params || {};
        return Object.keys(params).map(function(key) {
            return encodeURIComponent(key) + '=' + encodeURIComponent(params[key]);
        }).join('&');
    };

    /**
     * Build the drive upload URL
     *
     * @private
     * @param {string} [id] File ID if replacing
     * @param {object} [params] Query parameters
     * @return {string} URL
     */
    MediaUploader.prototype.buildUrl_ = function(id, params, baseUrl) {
        var url = baseUrl || 'https://www.googleapis.com/upload/drive/v3/files/';
        if (id) {
            url += id;
        }
        var query = this.buildQuery_(params);
        if (query) {
            url += '?' + query;
        }
        return url;
    };

    /**
     * Computes overall file size.
     *
     * @private
     * @return {number} number of bytes of the final file.
     */
    MediaUploader.prototype.totalSize_ = function() {
        var base = 0;
        var plaintext = 0;
        base += 16; // IV for file encryption.
        base += 0;  // TODO: Key wrapped with UO key.

        plaintext += 4;  // text message length, 4B field.
        if (this.textMsg){
            plaintext += eb.misc.strByteLength(this.textMsg);
        }

        if (this.file){
            plaintext += this.file.size;
        }

        return base + eb.misc.padToBlockSize(plaintext, 16);
    };


    function log(msg){
        console.log(msg);
        append_message(msg);
    }

    /**
     * Get settings from the form.
     * @returns {{remoteEndpoint: (*|jQuery), remotePort: number, requestMethod: (*|jQuery), requestScheme: (*|jQuery), requestTimeout: number, debuggingLog: boolean}}
     */
    function getSettings(){
        var apiKey = $('#apiKey').val();
        var keyId = parseInt($('#userObjectID').val(), 16);
        var endpoint = $('#endpoint').val();
        var method = $('#requestMethod').val();
        var scheme = $('#requestScheme').val();

        return {
            remoteEndpoint: endpoint,
            remotePort: 11180,
            requestMethod: method,
            requestScheme: scheme,
            requestTimeout: 30000,
            debuggingLog: true,
            apiKey: apiKey,
            apiKeyLow4Bytes: keyId,
            userObjectId : keyId
        };
    }

    function connectionError(data){
        $('#qrcode').html("");
        $('#qrcode2').html("");
        $('#userId').val("");
        $('#hotpSecret').val("");
        $('#htops').val("");
        $('#qrLink').val("");
        $('#userCtx').val("");
        $('#redirBlock').hide('slow');

        statusFieldSet($('#hotpStatus'), "Connection error", false);
    }

    function finished(response){
        var digits = $('#hotpDigits').val();

        var statusElem = $('#hotpStatus');
        var responseStatus = response.hotpStatus;
        if ((responseStatus === undefined || responseStatus == 0x0) && response.statusCode != eb.comm.status.SW_STAT_OK){
            responseStatus = response.statusCode;
        }

        var status = sprintf("0x%04X", responseStatus);
        if (responseStatus == eb.comm.status.SW_STAT_OK){
            status += ' - Context created successfully';
        } else if (responseStatus == eb.comm.status.SW_AUTHMETHOD_NOT_ALLOWED){
            status += ' - Failed, authentication method not allowed';
        } else {
            status += ' - Failed, unknown error';
        }

        statusFieldSet(statusElem, status, response.hotpStatus == eb.comm.status.SW_STAT_OK);
        if (response.hotpUserId){
            $('#userId').val(sjcl.codec.hex.fromBits(eb.comm.hotp.userIdToBits(response.hotpUserId)));
        }

        if (response.hotpKey){
            var hotpKeyBits = sjcl.codec.hex.fromBits(response.hotpKey);
            $('#hotpSecret').val(hotpKeyBits);
            $('#hotpSecretCrc').val(eb.misc.genChecksumValue(hotpKeyBits, 4));

            // HOTP codes - compute first 5, demo that it works.
            var i, codes=[];
            for(i=1; i<=5; i++){
                codes.push(""+eb.comm.hotp.hotpCompute(response.hotpKey, i, digits));
            }

            $('#htops').val(codes.join(" "));

            // QR code for picky iPhones.
            var qrLink2 = eb.comm.hotp.hotpGetQrLink(response.hotpKey, {
                label: sjcl.codec.hex.fromBits(response.hotpUserId),
                web: "demo.enigmabridge.com",
                issuer: "EnigmaBridge",
                ctr:0,
                digits: digits,
                stripPadding: true
            });
            $('#qrLink').val(qrLink2);
            log("QR link2: " + qrLink2);

            $('#qrcode').html("");
            $('#qrcode').qrcode(qrLink2);

            // Auth link.
            $('#redirBlock').show('slow');
            $('#redirHref').attr("href", sprintf("demoHotpAuth.html?key=%s&userId=%s&userCtx=%s&digits=%d",
                    sjcl.codec.hex.fromBits(response.hotpKey),
                    sjcl.codec.hex.fromBits(response.hotpUserId),
                    sjcl.codec.hex.fromBits(response.hotpUserCtx),
                    digits
            ));
        }

        if (response.hotpUserCtx){
            var userCtxBits = sjcl.codec.hex.fromBits(response.hotpUserCtx);
            $('#userCtx').val(userCtxBits);
            $('#userCtxCrc').val(eb.misc.genChecksumValue(userCtxBits, 4));
        }
    }

    function requestSimple(){
        var aesKey = $('#aesKey').val();
        var macKey = $('#macKey').val();
        var pDataMethod = $('#processDataMethod').val();
        var digits = $('#hotpDigits').val();
        var password = $('#authPassword').val();
        password = password ? password.trim() : '';
        var body = $("body");

        // Flush old messages.
        display_message("");
        set_request("");

        var logger = function(msg) {
            append_message(msg);
        };

        var endpointConfig = getSettings();
        var userConfig = {
            aesKey: aesKey,
            macKey: macKey,
            callRequestType: pDataMethod
        };

        // Configuration for creating a new auth context.
        // Nested is necessary as we can configure the whole stack with this configuration,
        // including endpoints, ports, protocols, schemes and so on.
        var reqConfig = {
            hotp:{
                methods: eb.comm.hotp.USERAUTH_FLAG_HOTP,
                hotp:{
                    digits: digits
                }
            }
        };

        // If password is configured, add it as an auth method.
        if (password && password.length > 0){
            reqConfig.hotp.methods |= eb.comm.hotp.USERAUTH_FLAG_PASSWD;
            reqConfig.hotp.passwd = reqConfig.hotp.passwd || {};
            reqConfig.hotp.passwd.hash = sjcl.hash.sha256.hash(password);
            log("Password configured. Hash=" + eb.misc.inputToHex(reqConfig.hotp.passwd.hash));
        }

        log("Create Auth context configuration: " + JSON.stringify(reqConfig));
        var request = new eb.comm.hotp.newHotpUserRequest(reqConfig);
        request.configure(userConfig);
        request.configure(endpointConfig);

        // Logging settings.
        request.logger = logger;

        // Callbacks settings.
        request.done(function(response, requestObj, data) {
            log("DONE! " + response.toString());
            finished(response);

        }).fail(function(failType, data){
            log("fail! type=" + failType + ", response="+(data && data.response ? data.response.toString() : 'undefined')+"\n data=" + JSON.stringify(data));
            if (failType == eb.comm.status.PDATA_FAIL_RESPONSE_FAILED){
                log("Fail msg: " + data.response.toString());
                finished(data.response);

            } else if (failType == eb.comm.status.PDATA_FAIL_CONNECTION){
                log("Connection error");
                connectionError(data);
            }

        }).always(function(request, data){
            log("it is over...");
            body.removeClass("loading");
        });

        // Build the request so we can display request in the form.
        request.build();
        set_request(sprintf("%s<br/>\n%s<br/>\n%s<br/>\n",
                request.getApiUrl(),
                JSON.stringify(request.getApiRequestData()),
                JSON.stringify(request.getSocketRequest())));

        // Do the call.
        statusFieldSet($('#hotpStatus'), '...');
        body.addClass("loading");

        request.doRequest();
    }

    /**
     * Callback for G+ Sign-in. Swaps views if login successful.
     */
    function signinCallback(result) {
        if(result.access_token) {
            accessToken = result.access_token;
            document.getElementById('signin').style.display = 'none';
            document.getElementById('signedin').style.display = null;
            $('#gDriveConfigHead').click();
        }
    }

    function logFiles(files){
        $.each( files, function( i, file )
        {
            log(sprintf("File: [%s], size: %s B, type: %s", file.name, file.size, file.type));
        });
    }

    function showFiles(files, $input, $label){
        logFiles(files);
        $label.text( files.length > 1 ? ( $input.attr( 'data-multiple-caption' ) || '' ).replace( '{count}', files.length ) : files[ 0 ].name );
    }

    function initUploadDiv(form){
        var $form = $(form);
        $fldInput		 = $form.find( 'input[type="file"]' );
        $fldLabel		 = $form.find( 'label' );
        $fldErrorMsg	 = $form.find( '.box__error span' );
        $fldRestart	 = $form.find( '.box__restart' );

        // On file change show file info.
        $fldInput.on( 'change', function( e )
        {
            showFiles( e.target.files, $fldInput, $fldLabel );
        });

        // drag&drop files if the feature is available
        if (!isAdvancedUpload){
            alert("Unsupported browser");
            return
        }

        $form
            .addClass( 'has-advanced-upload' ) // letting the CSS part to know drag&drop is supported by the browser
            .on( 'drag dragstart dragend dragover dragenter dragleave drop', function( e )
            {
                // preventing the unwanted behaviours
                e.preventDefault();
                e.stopPropagation();
            })
            .on( 'dragover dragenter', function() //
            {
                $form.addClass( 'is-dragover' );
            })
            .on( 'dragleave dragend drop', function()
            {
                $form.removeClass( 'is-dragover' );
            })
            .on( 'drop', function( e )
            {
                var newFiles = e.originalEvent.dataTransfer.files; // the files that were dropped
                if (newFiles.length > 1){
                    $fldLabel.text("Only one file is supported for now.");
                    logFiles(newFiles);
                    return;
                }

                droppedFiles = newFiles;
                showFiles( droppedFiles, $fldInput, $fldLabel );
            });

        // restart the form if has a state of error/success
        $fldRestart.on( 'click', function( e )
        {
            e.preventDefault();
            $form.removeClass( 'is-error is-success' );
            $fldInput.trigger( 'click' );
        });

        // Firefox focus bug fix for file input
        $fldInput
                .on( 'focus', function(){ $input.addClass( 'has-focus' ); })
                .on( 'blur', function(){ $input.removeClass( 'has-focus' ); });
    }

    function processClicked(){
        var $form = $(updForm);

        // preventing the duplicate submissions if the current one is in progress
        if( $form.hasClass( 'is-uploading' ) ){
            return false;
        }

        $form.addClass( 'is-uploading' ).removeClass( 'is-error' );

        if (!isAdvancedUpload){
            alert("Unsupported browser");
            return
        }

        // gathering the form data
        var ajaxData = new FormData( $form.get( 0 ) );
        if( droppedFiles && droppedFiles.length > 0 )
        {
            logFiles(droppedFiles);
            $.each( droppedFiles, function( i, file )
            {
                ajaxData.append( $fldInput.attr( 'name' ), file );
            });

            // Generate a new encryption key, random.
            var encKey = sjcl.random.randomWords(8);

            // TODO: encrypt encKey with UO.
            // ...

            // Encrypt file in the browser, upload to drive.
            var fFile = droppedFiles[0];
            var uploader = new MediaUploader({
                file: fFile,
                token: accessToken,
                encKey: encKey,
                onComplete: function(data) {
                    log("Upload complete: " + data);
                    $form.removeClass( 'is-uploading' );
//                    var element = document.createElement("pre");
//                    element.appendChild(document.createTextNode(data));
//                    document.getElementById('results').appendChild(element);
                },
                onError: function(data) {
                    log("Critical error: " + JSON.stringify(data));
                    $form.removeClass( 'is-uploading' ).addClass( data.success == true ? 'is-success' : 'is-error' );
                    $fldErrorMsg.text( data );
                }

            });
            uploader.upload();
        }
    }

    $(function(){
        // Start random number collectors.
        sjcl.random.startCollectors();
        $('#redirBlock').hide();

        // Init
        updForm = $('.box')[0];

        // HTML5 support?
        isAdvancedUpload = function()
        {
            var div = document.createElement( 'div' );
            return ( ( 'draggable' in div ) || ( 'ondragstart' in div && 'ondrop' in div ) ) && 'FormData' in window && 'FileReader' in window;
        }();

        // Init upload
        initUploadDiv(updForm);

        // Button click handling.
        $('#btnShare').click(function(){
            processClicked();
        });
    });

</script>
<script src="https://apis.google.com/js/client:plusone.js"></script>
<div class="modal"><div class="modal-wrap"></div></div>
</body>
</html>